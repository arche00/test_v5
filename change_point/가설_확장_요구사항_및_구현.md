# 가설 확장 및 배치 검증 요구사항 및 구현 문서

## 개요
임계점 스킵 + 앵커 우선순위 가설을 확장하여 추가 조건을 적용할 수 있도록 하고, 다양한 학습 비율로 배치 검증을 수행할 수 있는 기능을 구현했습니다.

---

## 1. 임계점 스킵 + 앵커 우선순위 가설 복제

### 구현 내용
- **클래스명**: `ThresholdSkipAnchorPriorityExtendedHypothesis`
- **위치**: `change_point_hypothesis_module.py` 491줄
- **레지스트리 이름**: `"threshold_skip_anchor_priority_extended"`

### 특징
- 기존 `ThresholdSkipAnchorPriorityHypothesis`의 모든 기능을 복제
- 검증 방식은 기존 가설과 **완전히 동일**하게 구현
- 추가 조건을 적용할 수 있는 확장 기능 제공

---

## 2. 복제한 가설에 새로운 조건 추가

### 구현 내용
- **추가 조건 파라미터**: `additional_condition`
- **타입**: 함수 `(prediction_dict, actual_value) -> bool`
- **동작 방식**:
  - `True`를 반환하면 예측을 사용
  - `False`를 반환하면 예측을 스킵

### 사용 예시
```python
def my_condition(prediction_dict, actual_value):
    # 예: 신뢰도가 60% 이상이고 b_ratio가 0.5 이상인 경우만 사용
    return prediction_dict["confidence"] >= 60.0 and prediction_dict.get("b_ratio", 0) >= 0.5

hypothesis = ThresholdSkipAnchorPriorityExtendedHypothesis(additional_condition=my_condition)
```

### prediction_dict 구조
```python
{
    "window_size": int,      # 윈도우 크기
    "prefix": str,           # prefix 문자열
    "predicted": str,        # 예측값
    "confidence": float,      # 신뢰도 (%)
    "b_ratio": float,        # b_ratio
    "p_ratio": float         # p_ratio
}
```

---

## 3. Grid String 검증 중 일치 결과 발생 시 종료

### 구현 내용
- **파라미터**: `stop_on_match` (bool)
- **기본값**: `False`
- **동작**: 
  - `True`로 설정하면, 각 grid_string 검증 중 예측값과 실제값이 일치하는 결과가 나오면 해당 grid_string에 대한 검증을 즉시 종료
  - 결과에 `stopped_early` 플래그 포함

### 적용 함수
- `validate_hypothesis_cp`
- `validate_threshold_skip_anchor_priority_cp`
- `validate_threshold_skip_anchor_priority_extended_cp`
- 모든 배치 검증 함수

### 사용 예시
```python
result = validate_threshold_skip_anchor_priority_extended_cp(
    grid_string_id=100,
    cutoff_grid_string_id=50,
    window_sizes=(8, 9, 10, 11, 12),
    method="빈도 기반",
    threshold=50,
    window_thresholds={8: 55, 9: 56, 10: 57, 11: 58, 12: 59},
    stop_on_match=True  # 일치 시 종료
)

if result.get("stopped_early"):
    print("일치 결과로 인해 조기 종료됨")
```

---

## 4. 학습 데이터 비율 선택 배치 검증

### 구현 내용

#### 4.1 단일 학습 비율 배치 검증
- **파라미터**: `train_ratio` (float, 0.0 ~ 1.0)
- **예시**: 
  - `train_ratio=0.6` → 60% 학습 / 40% 검증
  - `train_ratio=0.65` → 65% 학습 / 35% 검증

#### 4.2 여러 학습 비율 자동 배치 검증
- **함수**: `batch_validate_multiple_train_ratios`
- **위치**: `change_point_hypothesis_module.py` 1594줄
- **파라미터**:
  - `start_train_ratio`: 시작 학습 비율 (예: 0.6 = 60%)
  - `step_train_ratio`: 학습 비율 간격 (예: 0.05 = 5%)
  - `max_train_ratio`: 최대 학습 비율 (예: 0.95 = 95%)

### 사용 예시

#### 단일 학습 비율
```python
# 60% 학습 / 40% 검증
result = batch_validate_threshold_skip_anchor_priority_extended_cp(
    cutoff_grid_string_id=100,
    window_sizes=(8, 9, 10, 11, 12),
    method="빈도 기반",
    threshold=50,
    window_thresholds={8: 55, 9: 56, 10: 57, 11: 58, 12: 59},
    train_ratio=0.6,  # 60% 학습 / 40% 검증
    stop_on_match=True
)
```

#### 여러 학습 비율 자동 검증
```python
# 60%부터 95%까지 5% 간격으로 자동 검증
# → 60%, 65%, 70%, 75%, 80%, 85%, 90%, 95%
results = batch_validate_multiple_train_ratios(
    cutoff_grid_string_id=100,
    hypothesis="threshold_skip_anchor_priority_extended",
    window_sizes=(8, 9, 10, 11, 12),
    method="빈도 기반",
    threshold=50,
    window_thresholds={8: 55, 9: 56, 10: 57, 11: 58, 12: 59},
    start_train_ratio=0.6,    # 60% 시작
    step_train_ratio=0.05,    # 5% 간격
    max_train_ratio=0.95,      # 95%까지
    stop_on_match=True,
    additional_condition=my_condition
)

# 결과 확인
for ratio in results["train_ratios"]:
    summary = results["summary_by_ratio"][ratio]
    print(f"{ratio*100:.0f}% 학습: 평균 정확도 {summary['avg_accuracy']:.2f}%")
```

---

## 5. 윈도우 크기별 임계점 설정

### 구현 내용
- **파라미터**: `window_thresholds` (dict)
- **형식**: `{window_size: threshold}`
- **예시**: `{8: 55, 9: 56, 10: 57, 11: 58, 12: 59}`

### 동작 방식
- 각 윈도우 크기별로 개별 임계값 설정 가능
- `window_thresholds`가 제공되지 않으면 기본 `threshold` 값을 모든 윈도우에 적용
- 각 윈도우의 confidence가 해당 윈도우의 임계값 이상일 때만 예측 사용

### 사용 예시
```python
window_thresholds = {
    8: 55,   # 윈도우 8: 55% 이상
    9: 56,   # 윈도우 9: 56% 이상
    10: 57,  # 윈도우 10: 57% 이상
    11: 58,  # 윈도우 11: 58% 이상
    12: 59   # 윈도우 12: 59% 이상
}

result = batch_validate_threshold_skip_anchor_priority_extended_cp(
    cutoff_grid_string_id=100,
    window_sizes=(8, 9, 10, 11, 12),
    method="빈도 기반",
    threshold=50,  # 기본값 (window_thresholds가 없을 때 사용)
    window_thresholds=window_thresholds
)
```

---

## 6. 구현된 함수 목록

### 가설 클래스
1. **ThresholdSkipAnchorPriorityExtendedHypothesis** (491줄)
   - 확장 가설 클래스
   - 추가 조건 적용 가능
   - 윈도우 크기별 임계점 지원

### 검증 함수
1. **validate_threshold_skip_anchor_priority_extended_cp** (1174줄)
   - 확장 가설 단일 검증 함수
   - 기존 검증 방식과 동일
   - `stop_on_match` 지원

2. **batch_validate_threshold_skip_anchor_priority_extended_cp** (1487줄)
   - 확장 가설 배치 검증 함수
   - `train_ratio` 지원
   - `stop_on_match` 지원

3. **batch_validate_multiple_train_ratios** (1594줄)
   - 여러 학습 비율 자동 배치 검증 함수
   - 모든 가설 타입 지원
   - 시작 비율, 간격, 최대 비율 설정 가능

---

## 7. 주요 기능 요약

| 기능 | 상태 | 설명 |
|------|------|------|
| 가설 복제 | ✅ 완료 | ThresholdSkipAnchorPriorityExtendedHypothesis |
| 추가 조건 | ✅ 완료 | additional_condition 파라미터 |
| 일치 시 종료 | ✅ 완료 | stop_on_match 파라미터 |
| 단일 학습 비율 | ✅ 완료 | train_ratio 파라미터 |
| 여러 학습 비율 | ✅ 완료 | batch_validate_multiple_train_ratios |
| 윈도우별 임계점 | ✅ 완료 | window_thresholds 파라미터 |
| 검증 방식 동일 | ✅ 완료 | 기존 가설과 동일한 검증 로직 |

---

## 8. 사용 시나리오

### 시나리오 1: 기본 확장 가설 사용
```python
from change_point_hypothesis_module import ThresholdSkipAnchorPriorityExtendedHypothesis

hypothesis = ThresholdSkipAnchorPriorityExtendedHypothesis()
```

### 시나리오 2: 추가 조건이 있는 확장 가설
```python
def custom_condition(pred_dict, actual):
    return pred_dict["confidence"] >= 60.0

hypothesis = ThresholdSkipAnchorPriorityExtendedHypothesis(
    additional_condition=custom_condition
)
```

### 시나리오 3: 윈도우별 임계점 설정
```python
window_thresholds = {8: 55, 9: 56, 10: 57, 11: 58, 12: 59}

result = batch_validate_threshold_skip_anchor_priority_extended_cp(
    cutoff_grid_string_id=100,
    window_sizes=(8, 9, 10, 11, 12),
    method="빈도 기반",
    threshold=50,
    window_thresholds=window_thresholds,
    train_ratio=0.6,
    stop_on_match=True
)
```

### 시나리오 4: 여러 학습 비율 자동 검증
```python
results = batch_validate_multiple_train_ratios(
    cutoff_grid_string_id=100,
    hypothesis="threshold_skip_anchor_priority_extended",
    window_sizes=(8, 9, 10, 11, 12),
    method="빈도 기반",
    threshold=50,
    window_thresholds={8: 55, 9: 56, 10: 57, 11: 58, 12: 59},
    start_train_ratio=0.6,
    step_train_ratio=0.05,
    max_train_ratio=0.95,
    stop_on_match=True
)
```

---

## 9. 반환 데이터 구조

### 단일 검증 결과
```python
{
    "grid_string_id": int,
    "max_consecutive_failures": int,
    "total_steps": int,
    "total_failures": int,
    "total_predictions": int,
    "total_skipped": int,
    "accuracy": float,
    "history": list,
    "stopped_early": bool  # 일치 시 종료 여부
}
```

### 배치 검증 결과
```python
{
    "results": list,              # 각 grid_string의 검증 결과
    "summary": {
        "total_grid_strings": int,
        "avg_accuracy": float,
        "max_consecutive_failures": int,
        "avg_max_consecutive_failures": float,
        "total_steps": int,
        "total_failures": int,
        "total_predictions": int,
        "total_skipped": int,
        "total_stopped_early": int  # 조기 종료된 grid_string 수
    },
    "grid_string_ids": list,      # 검증된 grid_string ID 목록
    "train_grid_string_ids": list # 학습용 grid_string ID 목록
}
```

### 여러 학습 비율 검증 결과
```python
{
    "train_ratios": [0.6, 0.65, 0.7, ...],  # 학습 비율 목록
    "results_by_ratio": {
        0.6: {배치 검증 결과},
        0.65: {배치 검증 결과},
        ...
    },
    "summary_by_ratio": {
        0.6: {요약 통계},
        0.65: {요약 통계},
        ...
    }
}
```

---

## 10. 주의사항

1. **검증 방식 일치**: 확장 가설의 검증 방식은 기존 가설과 완전히 동일하게 구현되어 있습니다.

2. **윈도우별 임계점**: `window_thresholds`가 제공되지 않으면 기본 `threshold` 값이 모든 윈도우에 적용됩니다.

3. **학습 비율**: `train_ratio`는 0.0 ~ 1.0 사이의 값이어야 하며, None이면 cutoff 이후 모든 데이터를 검증합니다.

4. **일치 시 종료**: `stop_on_match=True`로 설정하면 첫 번째 일치 결과에서 검증이 종료되므로, 전체 검증 결과를 얻으려면 `False`로 설정해야 합니다.

5. **추가 조건**: `additional_condition` 함수는 `(prediction_dict, actual_value) -> bool` 형식이어야 합니다.

---

## 11. 변경 이력

- **2026-01-26**: 초기 구현 완료
  - ThresholdSkipAnchorPriorityExtendedHypothesis 클래스 추가
  - validate_threshold_skip_anchor_priority_extended_cp 함수 추가
  - batch_validate_threshold_skip_anchor_priority_extended_cp 함수 추가
  - batch_validate_multiple_train_ratios 함수 추가
  - stop_on_match 기능 추가
  - window_thresholds 지원
  - train_ratio 지원

---

## 12. 참고 파일

- **구현 파일**: `change_point/change_point_hypothesis_module.py`
- **테스트 앱**: `change_point/change_point_hypothesis_test_app.py`
