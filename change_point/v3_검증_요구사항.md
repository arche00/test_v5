# V3 검증 함수 요구사항 문서

## 1. 개요
본 시스템은 특정 앵커에서 윈도우를 확장하며 첫 번째 예측의 적중 여부를 우선 확인한다. 첫 시도가 실패할 경우에만 윈도우를 늘려가며 최대 3회 연속 불일치 여부를 검증하여 앵커의 유효성을 판단한다.

---

## 2. 핵심 처리 로직 (Core Logic)

### 2.1. 검증 시작 및 앵커 선택

**[REQ-101]** 현재 포지션(current_pos) 이후의 가장 빠른 앵커를 검증 대상으로 선정한다.

**[REQ-102]** 검증에 사용하는 윈도우 크기는 순차적으로 9, 10, 11, 12, 13, 14이다.

---

### 2.2. 단계별 검증 및 종료 조건 (Success vs Failure)

검증 루프는 아래 규칙에 따라 단 한 번의 성공 혹은 연속된 실패로 종결된다.

#### [RULE-1] 적중 시 즉시 종료 (Success Exit)
- 윈도우 $W_n$에서 예측값이 실제 결과와 **일치(Match)**하면, 그 즉시 해당 앵커에 대한 모든 검증을 성공으로 간주하고 종료한다.
- **전이**: 일치한 포지션의 다음 인덱스(matched_pos + 1)를 current_pos로 설정하고 다음 앵커를 찾는다.
- (예: 윈도우 9에서 바로 맞으면 10, 11...은 검사하지 않고 종료)

#### [RULE-2] 불일치 시 확장 검증 (Failure Sequence)
- 예측값이 **불일치(Mismatch)**할 경우에만 다음 윈도우 $W_{n+1}$로 넘어가 검증을 계속한다.
- 이 과정이 3회 연속 발생하면 해당 앵커 검증을 실패로 간주하고 종료한다.
- **전이**: 3번째 불일치가 발생한 포지션의 다음 인덱스(mismatched_pos + 1)를 current_pos로 설정하고 다음 앵커를 찾는다.

---

### 2.3. 검증 프로세스 시나리오 예시

#### Case 1 (즉시 성공)
```
윈도우 9 예측 [적중] → 종료 (다음 앵커 탐색)
```

#### Case 2 (지연 성공)
```
윈도우 9 [틀림] → 윈도우 10 [틀림] → 윈도우 11 [적중] → 종료 (다음 앵커 탐색)
```

#### Case 3 (최종 실패)
```
윈도우 9 [틀림] → 윈도우 10 [틀림] → 윈도우 11 [틀림] → 실패 종료 (3회 연속 불일치 확정, 다음 앵커 탐색)
```

---

## 3. 구현 세부사항

### 3.1. 앵커 선택 로직
- `current_pos` 이후의 가장 빠른 앵커를 검증 대상으로 선택
- 더 이상 검증할 앵커가 없으면 검증 종료

### 3.2. 윈도우 크기 순차 검증
- 윈도우 크기 9, 10, 11, 12, 13, 14를 순서대로 검증
- 각 윈도우 크기별로 예측 수행 및 실제값과 비교

### 3.3. 적중 시 처리
- 예측값이 실제값과 일치하면 즉시 해당 앵커 검증 종료
- `matched_pos + 1`을 `current_pos`로 설정하여 다음 앵커 탐색
- 해당 앵커의 나머지 윈도우 크기는 검증하지 않음

### 3.4. 불일치 시 처리
- 예측값이 불일치할 경우에만 다음 윈도우로 확장
- 3회 연속 불일치 발생 시:
  - 해당 앵커 검증을 실패로 간주하고 종료
  - 3번째 불일치 포지션의 다음 인덱스(`mismatched_pos + 1`)를 `current_pos`로 설정
  - 다음 앵커 탐색

### 3.5. 스킵 처리
- 예측 테이블에 값이 없는 경우 스킵 처리
- 스킵된 예측은 연속 실패 카운트에 포함하지 않음

---

## 4. 함수 시그니처

```python
def validate_first_anchor_extended_window_v3_cp(
    grid_string_id,
    cutoff_grid_string_id,
    window_sizes=(9, 10, 11, 12, 13, 14),
    method="빈도 기반",
    threshold=0,
    stop_on_match=False,
):
    """
    첫 앵커 확장 윈도우 V3 검증 함수 (앵커 기반 순차 검증 시스템)
    
    Args:
        grid_string_id: 검증할 grid_string ID
        cutoff_grid_string_id: cutoff ID (사용하지 않지만 호환성을 위해 유지)
        window_sizes: 윈도우 크기 목록 (기본값: 9, 10, 11, 12, 13, 14)
        method: 예측 방법
        threshold: 임계값
        stop_on_match: True이면 일치하는 결과가 나오면 검증 종료
        
    Returns:
        dict: 검증 결과
    """
```

---

## 5. 반환값 구조

```python
{
    "grid_string_id": int,
    "max_consecutive_failures": int,  # 전체 검증 중 최대 연속 불일치
    "total_steps": int,               # 총 검증 스텝 수
    "total_failures": int,            # 총 실패 횟수
    "total_predictions": int,        # 총 예측 횟수
    "total_skipped": int,            # 총 스킵 횟수
    "accuracy": float,               # 정확도 (%)
    "history": [                     # 상세 히스토리
        {
            "step": int,
            "position": int,
            "anchor": int,
            "window_size": int,
            "prefix": str,
            "predicted": str,
            "actual": str,
            "is_correct": bool,
            "confidence": float,
            "selected_window_size": int,
            "all_predictions": list,
            "skipped": bool,
            "skip_reason": str (optional),
        },
        ...
    ],
    "stopped_early": bool,
}
```

---

## 6. 주요 특징

1. **앵커 기반 순차 검증**: current_pos 이후의 가장 빠른 앵커를 선택하여 검증
2. **즉시 성공 종료**: 첫 적중 시 해당 앵커 검증 즉시 종료
3. **확장 검증**: 불일치 시에만 다음 윈도우로 확장
4. **3회 연속 실패 제한**: 3회 연속 불일치 시 앵커 실패로 간주
5. **동적 포지션 업데이트**: matched_pos 또는 mismatched_pos 기반으로 current_pos 업데이트

---

## 7. 예측값 사용 방식

### 7.1. 예측값 생성
- cutoff 이전 데이터(학습 데이터)로만 예측값 테이블 생성
- `save_or_update_predictions_for_change_point_data()` 함수 사용
- 윈도우 크기별로 독립적인 예측값 생성

### 7.2. 예측값 조회
- `stored_predictions_change_point` 테이블에서 조회
- 조건: `window_size`, `prefix`, `method`, `threshold` 일치
- 조회 실패 시 스킵 처리

---

## 8. 변경 이력

- 2026-01-27: V3 검증 함수 초기 구현
  - 앵커 기반 순차 검증 시스템 구현
  - 적중 시 즉시 종료 로직 추가
  - 3회 연속 불일치 시 앵커 전환 로직 추가
