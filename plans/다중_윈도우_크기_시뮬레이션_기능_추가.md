---
name: 다중 윈도우 크기 시뮬레이션 기능 추가
overview: optimal_threshold_finder_app.py에 stored_predictions 테이블을 활용한 다중 윈도우 크기 시뮬레이션 기능을 추가합니다. 각 위치에서 여러 윈도우 크기(5, 6, 7, 8, 9) 중 최고 신뢰도 예측값을 선택하는 전략을 구현합니다.
todos:
  - id: import-functions
    content: hypothesis_validation_app.py에서 create_stored_predictions_table, save_or_update_predictions_for_historical_data 함수 import 추가
    status: pending
  - id: add-multi-window-prediction
    content: get_multi_window_prediction() 함수 구현 - stored_predictions 테이블에서 여러 윈도우 크기별 예측 조회 후 최고 신뢰도 선택
    status: pending
    dependencies:
      - import-functions
  - id: add-validate-multi-window
    content: validate_multi_window_scenario() 함수 구현 - 단일 grid_string에 대한 다중 윈도우 검증
    status: pending
    dependencies:
      - add-multi-window-prediction
  - id: add-batch-validate
    content: batch_validate_multi_window_scenario() 함수 구현 - 배치 검증 및 통계 집계
    status: pending
    dependencies:
      - add-validate-multi-window
  - id: add-ui-table-management
    content: 예측값 테이블 관리 UI 섹션 추가 - 테이블 생성 버튼, 예측값 생성 버튼, 상태 확인
    status: pending
    dependencies:
      - import-functions
  - id: add-ui-simulation
    content: 다중 윈도우 크기 시뮬레이션 UI 섹션 추가 - 설정 폼, 실행 버튼, 결과 표시
    status: pending
    dependencies:
      - add-batch-validate
      - add-ui-table-management
---

# 다중 윈도우 크기 시뮬레이션 기능 추가 계획

## 1. 필요한 함수 import 및 추가

### 1.1 hypothesis_validation_app.py에서 함수 import

- `create_stored_predictions_table()`: 테이블 생성 함수
- `save_or_update_predictions_for_historical_data()`: 예측값 저장 함수
- `get_db_connection()`: DB 연결 함수 (이미 import됨)
- `load_preprocessed_data()`: 데이터 로드 함수 (이미 import됨)

### 1.2 새로운 함수 추가

- `get_multi_window_prediction()`: 여러 윈도우 크기 중 최고 신뢰도 예측값 선택
- `validate_multi_window_scenario()`: 단일 grid_string에 대한 다중 윈도우 검증
- `batch_validate_multi_window_scenario()`: 배치 검증 함수

## 2. UI 섹션 추가 (main() 함수 하단)

### 2.1 구분선 추가

- 기존 시뮬레이션 결과 표시 후 `st.markdown("---")` 추가

### 2.2 예측값 테이블 관리 섹션

- 제목: "예측값 테이블 관리"
- 테이블 생성 버튼: `create_stored_predictions_table()` 호출
- 예측값 생성 버튼: `save_or_update_predictions_for_historical_data()` 호출
  - 설정: cutoff_grid_string_id, window_sizes=[5, 6, 7, 8, 9], method, threshold=0
  - 진행 상황 표시 (progress bar)
- 테이블 상태 확인: 현재 저장된 예측값 개수 표시

### 2.3 다중 윈도우 크기 시뮬레이션 섹션

- 제목: "다중 윈도우 크기 시뮬레이션"
- 설정 폼:
  - 기준 Grid String ID 선택
  - 윈도우 크기 리스트 (5, 6, 7, 8, 9) - 체크박스로 다중 선택
  - 예측 방법 선택 (빈도 기반, 가중치 기반, 안전 우선)
  - 임계값 (기본값: 0)
- 시뮬레이션 실행 버튼
- 결과 표시:
  - 최대 연속 불일치
  - 평균 정확도
  - 총 예측 횟수
  - 각 grid_string별 상세 결과 테이블
  - 히스토리 표시 (선택된 윈도우 크기, 신뢰도 등)

## 3. 구현 세부사항

### 3.1 get_multi_window_prediction() 함수

```python
def get_multi_window_prediction(
    grid_string,
    position,
    window_sizes=[5, 6, 7, 8, 9],
    method="빈도 기반",
    threshold=0
):
    """
    여러 윈도우 크기 중 가장 높은 신뢰도를 가진 예측값 선택
    
    - stored_predictions 테이블에서 각 윈도우 크기별 예측 조회
    - 신뢰도가 가장 높은 예측값 반환
    - 모든 윈도우 크기별 예측 결과도 함께 반환
    """
```

### 3.2 validate_multi_window_scenario() 함수

```python
def validate_multi_window_scenario(
    grid_string_id,
    cutoff_grid_string_id,
    window_sizes=[5, 6, 7, 8, 9],
    method="빈도 기반",
    threshold=0
):
    """
    다중 윈도우 크기 전략으로 검증
    
    - 각 위치에서 get_multi_window_prediction() 호출
    - 최고 신뢰도 예측값으로 검증
    - 히스토리에 선택된 윈도우 크기 정보 포함
    """
```

### 3.3 batch_validate_multi_window_scenario() 함수

```python
def batch_validate_multi_window_scenario(
    cutoff_grid_string_id,
    window_sizes=[5, 6, 7, 8, 9],
    method="빈도 기반",
    threshold=0
):
    """
    배치 검증 및 통계 집계
    """
```

## 4. 파일 수정 위치

### 4.1 optimal_threshold_finder_app.py

- 상단 import 섹션: hypothesis_validation_app에서 필요한 함수 추가 import
- 함수 정의 섹션: 새로운 3개 함수 추가 (get_multi_window_prediction, validate_multi_window_scenario, batch_validate_multi_window_scenario)
- main() 함수: 기존 시뮬레이션 결과 표시 후 (약 1008번째 줄 이후) 새로운 섹션 추가

## 5. 데이터 흐름

```
사용자 설정
  ↓
예측값 테이블 생성/확인
  ↓
stored_predictions 테이블 조회
  ↓
각 위치에서 다중 윈도우 크기 예측 조회
  ↓
최고 신뢰도 예측값 선택
  ↓
검증 및 결과 수집
  ↓
통계 계산 및 표시
```

## 6. 주의사항

- stored_predictions 테이블이 비어있으면 경고 메시지 표시
- 예측값 생성은 시간이 오래 걸릴 수 있으므로 progress bar 필수
- 윈도우 크기 5는 이미 window_sizes 리스트에 포함되어 있음
- threshold=0은 임계값 없이 모든 예측 포함을 의미
